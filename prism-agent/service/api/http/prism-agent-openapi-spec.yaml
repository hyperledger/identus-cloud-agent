openapi: 3.0.1
info:
  title: Prism Agent OpenAPI specification
  description: OpenAPI specification for Decentralized Identifiers (DID) Operations
  version: 0.41.0
  contact:
    name: Core DID
    email: atala-coredid@iohk.io
servers:
  - url: "https://k8s-dev.atalaprism.io/prism-agent/"
  - url: "http://localhost/prism-agent"

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: apikey
security:
  - ApiKeyAuth: []
tags:
  # Castor
  - name: DID
    description: DID REST API
  - name: DID Registrar
    description: DID Registrar REST API (Prism Agent managed DID)
  # Pollux
  - name: Schema Registry
    description: Schema Registry REST API
  - name: Verification
    description: Verification Policies REST API
  - name: Present Proof
    description: Present Proof REST API
  # Connect
  - name: Connections Management
    description: Manage [DIDComm v2](https://identity.foundation/didcomm-messaging/spec/v2.0/) connections

paths:
  # ----------------------------------
  # Castor
  # ----------------------------------
  /dids/{didRef}:
    get:
      operationId: getDid
      tags: ["DID"]
      summary: Resolve Prism DID
      description: Resolve Prism DID to a DID document.
      parameters:
        - $ref: "./castor/parameters.yaml#/components/parameters/didRefInPath"
      responses:
        "200":
          description: The DID resource
          content:
            application/json:
              schema:
                $ref: "./castor/schemas.yaml#/components/schemas/DIDResponse"
        "404":
          $ref: "./shared/responses.yaml#/components/responses/NotFound"

  /did-registrar/dids:
    get:
      operationId: listManagedDid
      tags: ["DID Registrar"]
      summary: List all DIDs stored in Prism Agent's wallet
      description: |
        List all DIDs stored in Prism Agent's wallet.
        Return a paginated items ordered by created timestamp.
        If the `limit` parameter is not set, it defaults to 100 items per page.
      parameters:
        - $ref: "./shared/parameters.yaml#/components/parameters/offset"
        - $ref: "./shared/parameters.yaml#/components/parameters/limit"
      responses:
        "200":
          description: List Prism Agent managed DIDs
          content:
            application/json:
              schema:
                $ref: "./castor/schemas.yaml#/components/schemas/ManagedDIDPage"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

    post:
      operationId: createManagedDid
      tags: ["DID Registrar"]
      summary: Create unpublished DID and store it in Prism Agent's wallet
      description: |
        Create unpublished DID and store it inside Prism Agent's wallet. The private keys of the DID is
        managed by Prism Agent. The DID can later be published to the VDR using publications endpoint.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "./castor/schemas.yaml#/components/schemas/CreateManagedDidRequest"
      responses:
        "201":
          description: Created unpublished DID.
          content:
            application/json:
              schema:
                $ref: "./castor/schemas.yaml#/components/schemas/CreateManagedDIDResponse"
        "422":
          description: The DID creation failed.
          content:
            application/json:
              schema:
                $ref: "./shared/schemas.yaml#/components/schemas/ErrorResponse"

  /did-registrar/dids/{didRef}:
    get:
      operationId: getManagedDid
      tags: ["DID Registrar"]
      summary: Get DID stored in Prism Agent's wallet
      description: Get DID stored in Prism Agent's wallet
      parameters:
        - $ref: "./castor/parameters.yaml#/components/parameters/didRefInPath"
      responses:
        "200":
          description: Get Prism Agent managed DID
          content:
            application/json:
              schema:
                $ref: "./castor/schemas.yaml#/components/schemas/ManagedDID"
        "404":
          $ref: "./shared/responses.yaml#/components/responses/NotFound"

  /did-registrar/dids/{didRef}/publications:
    post:
      operationId: publishManagedDid
      tags: ["DID Registrar"]
      summary: Publish the DID stored in Prism Agent's wallet to the VDR
      description: |
        Publish the DID stored in Prism Agent's wallet to the VDR.
      parameters:
        - $ref: "./castor/parameters.yaml#/components/parameters/didRefInPath"
      responses:
        "202":
          description: Publishing DID to the VDR.
          content:
            application/json:
              schema:
                $ref: "./castor/schemas.yaml#/components/schemas/DIDOperationResponse"
        "422":
          description: The DID publication failed.
          content:
            application/json:
              schema:
                $ref: "./shared/schemas.yaml#/components/schemas/ErrorResponse"

  /did-registrar/dids/{didRef}/updates:
    post:
      operationId: updateManagedDid
      tags: ["DID Registrar"]
      summary: Update DID in Prism Agent's wallet and post update operation to the VDR
      description: |
        Update DID in Prism Agent's wallet and post update operation to the VDR.
        This endpoint updates the DID document from the last confirmed operation.
        Submitting multiple update operations without waiting for confirmation will result in
        some operations being rejected as only one operation is allowed to be appended to the last confirmed operation.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "./castor/schemas.yaml#/components/schemas/UpdateManagedDIDRequest"
      parameters:
        - $ref: "./castor/parameters.yaml#/components/parameters/didRefInPath"
      responses:
        "202":
          description: Publishing DID to the VDR.
          content:
            application/json:
              schema:
                $ref: "./castor/schemas.yaml#/components/schemas/DIDOperationResponse"
        "422":
          description: The DID update failed.
          content:
            application/json:
              schema:
                $ref: "./shared/schemas.yaml#/components/schemas/ErrorResponse"

  /did-registrar/dids/{didRef}/deactivations:
    post:
      operationId: deactivateManagedDid
      tags: ["DID Registrar"]
      summary: Deactivate DID in Prism Agent's wallet and post deactivate operation to the VDR
      description: |
        Deactivate DID in Prism Agent's wallet and post deactivate operation to the VDR.
      parameters:
        - $ref: "./castor/parameters.yaml#/components/parameters/didRefInPath"
      responses:
        "202":
          description: DID deactivation to VDR successfully queued.
          content:
            application/json:
              schema:
                $ref: "./castor/schemas.yaml#/components/schemas/DIDOperationResponse"
        "422":
          description: The DID deactivation failed.
          content:
            application/json:
              schema:
                $ref: "./shared/schemas.yaml#/components/schemas/ErrorResponse"

  # ----------------------------------
  # Pollux
  # ----------------------------------
  /schema-registry/schemas:
    get:
      tags:
        - Schema Registry
      summary: Lookup schemas by indexed fields
      description:
        "Lookup schemas by `author`, `name`, `tags` parameters and control
        the pagination by `offset` and `limit` parameters"
      operationId: lookupSchemasByQuery
      parameters:
        - name: author
          in: query
          required: false
          schema:
            type: string
          example: did:prism:4a5b5cf0a513e83b598bbea25cd6196746747f361a73ef77068268bc9bd732ff
        - name: name
          in: query
          required: false
          schema:
            type: string
          example: DrivingLicense
        - name: version
          in: query
          required: false
          schema:
            type: string
          example: 1.0.0
        - name: tags
          in: query
          required: false
          schema:
            type: string
          example: driving
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            format: int32
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            format: int32
        - name: order
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Collection of CredentialSchema records.
          content:
            application/json:
              schema:
                $ref: "./pollux/schemas.yaml#/components/schemas/CredentialSchemaResponsePage"
        "400":
          $ref: "./shared/responses.yaml#/components/responses/BadRequest"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

    post:
      tags:
        - Schema Registry
      summary: Publish new schema to the schema registry
      description:
        Create the new credential schema record with metadata and internal
        JSON Schema on behalf of Cloud Agent. The credential schema will be signed
        by the keys of Cloud Agent and issued by the DID that corresponds to it
      operationId: createSchema
      requestBody:
        description: JSON object required for the credential schema creation
        content:
          application/json:
            schema:
              $ref: "./pollux/schemas.yaml#/components/schemas/CredentialSchemaInput"
        required: true
      responses:
        "201":
          description: "The new credential schema record is successfully created"
          content:
            application/json:
              schema:
                $ref: "./pollux/schemas.yaml#/components/schemas/CredentialSchemaResponse"
        "400":
          $ref: "./shared/responses.yaml#/components/responses/BadRequest"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

  /schema-registry/schemas/{guid}:
    get:
      tags:
        - Schema Registry
      summary: Fetch the schema from the registry by `guid`
      description: Fetch the credential schema by the unique identifier
      operationId: getSchemaById
      parameters:
        - name: guid
          in: path
          description: Globally unique identifier of the credential schema record
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: CredentialSchema found by `guid`
          content:
            application/json:
              schema:
                $ref: "./pollux/schemas.yaml#/components/schemas/CredentialSchemaResponse"
        "404":
          $ref: "./shared/responses.yaml#/components/responses/NotFound"
        "400":
          $ref: "./shared/responses.yaml#/components/responses/BadRequest"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

  # ----------------------------------
  # Verification Policies
  # ----------------------------------
  /verification/policies:
    get:
      operationId: lookupVerificationPoliciesByQuery
      tags:
        - Verification
      summary: Lookup verification policies by query
      description: Lookup verification policies by `name`
      parameters:
        - $ref: ./shared/parameters.yaml#/components/parameters/offset
        - $ref: ./shared/parameters.yaml#/components/parameters/limit
        - name: name
          in: query
          required: false
          schema:
            type: string
        - name: order
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: "List of Verification policies"
          content:
            application/json:
              schema:
                $ref: "./pollux/schemas.yaml#/components/schemas/VerificationPolicyPage"
        "400":
          $ref: "./shared/responses.yaml#/components/responses/BadRequest"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"
    post:
      operationId: createVerificationPolicy
      tags:
        - Verification
      summary: Create the new verification policy
      description: Create the new verification policy
      requestBody:
        description: Create verification policy object
        content:
          application/json:
            schema:
              $ref: "./pollux/schemas.yaml#/components/schemas/VerificationPolicyInput"
        required: true
      responses:
        "201":
          description: "Verification policy created successfully"
          content:
            application/json:
              schema:
                $ref: "./pollux/schemas.yaml#/components/schemas/VerificationPolicy"
        "400":
          $ref: "./shared/responses.yaml#/components/responses/BadRequest"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

  /verification/policies/{id}:
    get:
      operationId: getVerificationPolicyById
      tags:
        - Verification
      summary: Fetch the verification policy by id
      description: Get the verification policy by id
      parameters:
        - name: id
          in: path
          description: Get the verification policy by id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: "Verification policy"
          content:
            application/json:
              schema:
                $ref: "./pollux/schemas.yaml#/components/schemas/VerificationPolicy"
        "400":
          $ref: "./shared/responses.yaml#/components/responses/BadRequest"
        "404":
          $ref: "./shared/responses.yaml#/components/responses/NotFound"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"
    put:
      operationId: updateVerificationPolicy
      tags:
        - Verification
      summary: Update the verification policy object by id
      description: Update the verification policy entry
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: nonce
          in: query
          description: Nonce of the previous VerificationPolicy
          required: true
          schema:
            type: integer
            format: int32
      requestBody:
        description: Update verification policy object
        content:
          application/json:
            schema:
              $ref: "./pollux/schemas.yaml#/components/schemas/VerificationPolicyInput"
        required: true
      responses:
        "200":
          description: "Verification policy updated successfully"
          content:
            application/json:
              schema:
                $ref: "./pollux/schemas.yaml#/components/schemas/VerificationPolicy"
        "400":
          $ref: "./shared/responses.yaml#/components/responses/BadRequest"
        "404":
          $ref: "./shared/responses.yaml#/components/responses/NotFound"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"
    delete:
      operationId: deleteVerificationPolicyById
      tags:
        - Verification
      summary: Delete the verification policy by id
      description: Delete the verification policy by id
      parameters:
        - name: id
          in: path
          description: Delete the verification policy by id
          required: true
          schema:
            type: string
            format: uuid
        - name: nonce
          in: query
          description: Nonce of the previous VerificationPolicy
          required: true
          schema:
            type: integer
            format: int32
      responses:
        "200":
          description: "Verification policy deleted successfully"
          content:
            application/json:
              schema:
                type: object
        "400":
          $ref: "./shared/responses.yaml#/components/responses/BadRequest"
        "404":
          $ref: "./shared/responses.yaml#/components/responses/NotFound"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

  ## Issue Credential Protocol

  /issue-credentials/credential-offers:
    post:
      operationId: createCredentialOffer
      tags: ["Issue Credentials Protocol"]
      summary: As a credential issuer, create a new credential offer to be sent to a holder.
      description: Creates a new credential offer in the database
      requestBody:
        description: The credential offer object.
        required: true
        content:
          application/json:
            schema:
              $ref: "./pollux/schemas.yaml#/components/schemas/CreateIssueCredentialRecordRequest"
      responses:
        "201":
          description: The issue credential record was created successfully, and is returned in the response body.
          content:
            application/json:
              schema:
                $ref: "./pollux/schemas.yaml#/components/schemas/IssueCredentialRecord"
        "422":
          description: The issue credential record creation failed. More information on the error can be found in the response body.
          content:
            application/json:
              schema:
                $ref: "./shared/schemas.yaml#/components/schemas/ErrorResponse"

  /issue-credentials/records:
    get:
      operationId: getCredentialRecords
      tags: ["Issue Credentials Protocol"]
      summary: Gets the list of issue credential records.
      description: Get the list of issue credential records paginated
      parameters:
        - $ref: "./shared/parameters.yaml#/components/parameters/offset"
        - $ref: "./shared/parameters.yaml#/components/parameters/limit"
        - name: thid
          in: query
          description: The thid of a DIDComm communication.
          required: false
          schema:
            type: string
      responses:
        "200":
          description: The list of issue credential records.
          content:
            application/json:
              schema:
                $ref: "./pollux/schemas.yaml#/components/schemas/IssueCredentialRecordPage"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

  /issue-credentials/records/{recordId}:
    get:
      operationId: getCredentialRecord
      tags: ["Issue Credentials Protocol"]
      summary: Gets an existing issue credential record by its unique identifier.
      description: Gets issue credential records by record id
      parameters:
        - $ref: "./pollux/parameters.yaml#/components/parameters/issueCredentialRecordIdInPath"
      responses:
        "200":
          description: The issue credential record.
          content:
            application/json:
              schema:
                $ref: "./pollux/schemas.yaml#/components/schemas/IssueCredentialRecord"
        "404":
          $ref: "./shared/responses.yaml#/components/responses/NotFound"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

  /issue-credentials/records/{recordId}/accept-offer:
    post:
      operationId: acceptCredentialOffer
      tags: ["Issue Credentials Protocol"]
      summary: As a holder, accepts a credential offer received from an issuer.
      description: Accepts a credential offer received from a VC issuer and sends back a credential request.
      parameters:
        - $ref: "./pollux/parameters.yaml#/components/parameters/issueCredentialRecordIdInPath"
      requestBody:
        description: The accept credential offer request object.
        required: true
        content:
          application/json:
            schema:
              $ref: ./pollux/schemas.yaml#/components/schemas/AcceptCredentialOfferRequest
      responses:
        "200":
          description: The issue credential offer was successfully accepted.
          content:
            application/json:
              schema:
                $ref: ./pollux/schemas.yaml#/components/schemas/IssueCredentialRecord
        "404":
          $ref: "./shared/responses.yaml#/components/responses/NotFound"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

  /issue-credentials/records/{recordId}/issue-credential:
    post:
      operationId: issueCredential
      tags: ["Issue Credentials Protocol"]
      summary: As an issuer, issues the verifiable credential related to the specified record.
      description: |
        Sends credential to a holder (holder DID is specified in credential as subjectDid).
        Credential is constructed from the credential records found by credential id.
      parameters:
        - $ref: ./pollux/parameters.yaml#/components/parameters/issueCredentialRecordIdInPath
      responses:
        "200":
          description: The request was processed successfully and the credential will be issued asynchronously.
          content:
            application/json:
              schema:
                $ref: ./pollux/schemas.yaml#/components/schemas/IssueCredentialRecord
        "404":
          $ref: "./shared/responses.yaml#/components/responses/NotFound"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

  ## Present proof

  /present-proof/presentations:
    post:
      operationId: requestPresentation
      tags: ["Present Proof"]
      summary: As a Verifier, create a new proof presentation request and send it to the Prover.
      description: Holder presents proof derived from the verifiable credential to verifier.
      requestBody:
        description: The present proof creation request.
        required: true
        content:
          application/json:
            schema:
              $ref: "./pollux/schemas.yaml#/components/schemas/RequestPresentationInput"
      responses:
        "201":
          description: The proof presentation request was created successfully and will be sent asynchronously to the Prover.
          content:
            application/json:
              schema:
                $ref: "./pollux/schemas.yaml#/components/schemas/RequestPresentationOutput"
        "422":
          description: Creating the proof presentation request failed for an unexpected reason. More information on the error can be found in the response body.
          content:
            application/json:
              schema:
                $ref: "./shared/schemas.yaml#/components/schemas/ErrorResponse"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

    get:
      operationId: getAllPresentation
      tags: ["Present Proof"]
      summary: Gets the list of proof presentation records.
      description: list of presentation statuses
      parameters:
        - $ref: "./shared/parameters.yaml#/components/parameters/offset"
        - $ref: "./shared/parameters.yaml#/components/parameters/limit"
        - name: thid
          in: query
          description: The thid of a DIDComm communication.
          required: false
          schema:
            type: string
      responses:
        "200":
          description: The list of proof presentation records.
          content:
            application/json:
              schema:
                $ref: "./pollux/schemas.yaml#/components/schemas/PresentationStatusPage"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

  /present-proof/presentations/{recordId}:
    patch:
      operationId: updatePresentation
      tags: ["Present Proof"]
      summary: Updates the proof presentation record matching the unique identifier, with the specific action to perform.
      description: Accept or reject presentation of proof request
      parameters:
        - $ref: ./pollux/parameters.yaml#/components/parameters/presentationRecordIdInPath
      requestBody:
        description: The action to perform on the proof presentation record.
        required: true
        content:
          application/json:
            schema:
              $ref: "./pollux/schemas.yaml#/components/schemas/RequestPresentationAction"
      responses:
        "200":
          description: The proof presentation record was successfully updated.
          content:
            application/json: {}
        "404":
          $ref: "./shared/responses.yaml#/components/responses/NotFound"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"
    get:
      operationId: getPresentation
      tags: ["Present Proof"]
      summary: Gets an existing proof presentation record by its unique identifier. More information on the error can be found in the response body.
      description: Returns an existing presentation record by id.
      parameters:
        - $ref: "./pollux/parameters.yaml#/components/parameters/presentationRecordIdInPath"
      responses:
        "200":
          description: The proof presentation record.
          content:
            application/json:
              schema:
                $ref: "./pollux/schemas.yaml#/components/schemas/PresentationStatus"
        "404":
          $ref: "./shared/responses.yaml#/components/responses/NotFound"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

  # ----------------------------------
  # Connect
  # ----------------------------------
  /connections:
    post:
      operationId: createConnection
      tags: ["Connections Management"]
      summary: Creates a new connection record and returns an Out of Band invitation.
      description: |
        Generates a new Peer DID and creates an [Out of Band 2.0](https://identity.foundation/didcomm-messaging/spec/v2.0/#out-of-band-messages) invitation.
        It returns a new connection record in `InvitationGenerated` state.
        The request body may contain a `label` that can be used as a human readable alias for the connection, for example `{'label': "Bob"}`
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "./connect/schemas.yaml#/components/schemas/CreateConnectionRequest"

      responses:
        "201":
          description: The connection record was created successfully, and is returned in the response body.
          content:
            application/json:
              schema:
                $ref: "./connect/schemas.yaml#/components/schemas/Connection"
        "422":
          description: The connection record creation failed. More information on the error can be found in the response body.
          content:
            application/json:
              schema:
                $ref: "./shared/schemas.yaml#/components/schemas/ErrorResponse"

    get:
      operationId: getConnections
      tags: ["Connections Management"]
      summary: Gets the list of connection records.
      description: Get the list of connection records paginated
      parameters:
        - $ref: "./shared/parameters.yaml#/components/parameters/offset"
        - $ref: "./shared/parameters.yaml#/components/parameters/limit"
      responses:
        "200":
          description: The list of connection records.
          content:
            application/json:
              schema:
                $ref: "./connect/schemas.yaml#/components/schemas/ConnectionsPage"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

  /connections/{connectionId}:
    get:
      operationId: getConnection
      tags: ["Connections Management"]
      summary: Gets an existing connection record by its unique identifier.
      description: Gets an existing connection record by its unique identifier
      parameters:
        - $ref: "./connect/parameters.yaml#/components/parameters/connectionId"
      responses:
        "200":
          description: The connection record.
          content:
            application/json:
              schema:
                $ref: "./connect/schemas.yaml#/components/schemas/Connection"
        "404":
          $ref: "./shared/responses.yaml#/components/responses/NotFound"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"

  /connection-invitations:
    post:
      operationId: acceptConnectionInvitation
      tags: ["Connections Management"]
      summary: Accepts an Out of Band invitation.
      description: |
        Accepts an [Out of Band 2.0](https://identity.foundation/didcomm-messaging/spec/v2.0/#out-of-band-messages) invitation, generates a new Peer DID,
        and submits a Connection Request to the inviter.
        It returns a connection object in `ConnectionRequestPending` state, until the Connection Request is eventually sent to the inviter by the prism-agent's background process. The connection object state will then automatically move to `ConnectionRequestSent`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "./connect/schemas.yaml#/components/schemas/AcceptConnectionInvitationRequest"

      responses:
        "200":
          description: The invitation was successfully accepted.
          content:
            application/json:
              schema:
                $ref: "./connect/schemas.yaml#/components/schemas/Connection"
        "500":
          $ref: "./shared/responses.yaml#/components/responses/InternalServerError"
